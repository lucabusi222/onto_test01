<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Experimental Norms Form — IL‑33 Demo Ready</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
  :root {
    --radius-2xl: 1rem;
    --shadow-1: 0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.03);
    --shadow-2: 0 10px 15px rgba(0,0,0,.1), 0 4px 6px rgba(0,0,0,.05);
    --indigo-500: #6366f1;
    --indigo-600: #4f46e5;
    --rose-600: #e11d48;
    --gray-50: #f9fafb; --gray-100:#f3f4f6; --gray-300:#d1d5db; --gray-500:#6b7280; --gray-700:#374151;
    --white:#fff; --black:#111827;
  }
  body { background: var(--gray-50); color: var(--black); }
  .card { background:#fff; border-radius: var(--radius-2xl); box-shadow: var(--shadow-2); padding: 1.5rem; }
  .section-title { font-size: 1.25rem; font-weight: 600; margin: 1rem 0 .5rem; }
  .subgrid { display:grid; grid-template-columns: 1fr; gap:1rem; }
  @media (min-width: 768px){ .subgrid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
  label { display:block; font-size:.875rem; font-weight:500; color:var(--gray-700); margin-bottom:.25rem; }
  input[type="text"], input[type="number"], textarea, select {
    width:100%; border:1px solid var(--gray-300); border-radius:.75rem; padding:.5rem .75rem;
    outline:none;
  }
  input:focus, textarea:focus, select:focus { border-color: var(--indigo-500); box-shadow: 0 0 0 2px rgba(99,102,241,.3); }
  .btn {
    display:inline-flex; align-items:center; justify-content:center; border-radius:.75rem; padding:.5rem 1rem;
    font-size:.875rem; font-weight:600; border:1px solid var(--gray-300); background:#fff; color:#111;
    transition: background .15s ease, color .15s ease, border-color .15s ease;
  }
  .btn-primary { background: var(--indigo-600); color:#fff; border-color: transparent; }
  .btn-primary:hover { filter:brightness(0.95); }
  .btn-secondary:hover { background: var(--gray-100); }
  .btn-danger { background: var(--rose-600); color:#fff; border-color: transparent; }
</style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-6xl mx-auto p-4 md:p-8 space-y-6">
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">Experimental Norms Form</h1>
        <p class="text-gray-600">Machine-readable capture of oncology experiments — includes an IL‑33/Eosinophil EV demo.</p>
      </div>
      <nav class="flex flex-wrap gap-2">
        <button id="btn-demo-fill" type="button" class="btn btn-primary">Demo fill (IL‑33)</button>
        <button id="btn-reset" type="button" class="btn btn-secondary">Reset</button>
        <button id="btn-export" type="button" class="btn btn-secondary">Export JSON</button>
        <label class="btn btn-secondary cursor-pointer">
          <span>Import JSON</span>
          <input id="file-import" type="file" accept="application/json" class="hidden" />
        </label>
      </nav>
    </header>

    <form id="exp-form" class="space-y-6">
      <!-- GENERAL -->
      <section class="card">
        <h2 class="section-title">General</h2>
        <div class="subgrid">
          <div>
            <label for="project_id">Project ID</label>
            <input id="project_id" name="project_id" type="text" placeholder="OCC-2025-XXXX" />
          </div>
          <div>
            <label for="species">Species</label>
            <input id="species" name="species" type="text" placeholder="Homo sapiens (9606)" />
          </div>
          <div>
            <label for="tissue">Tissue (UBERON)</label>
            <input id="tissue" name="tissue" type="text" placeholder="UBERON:0000178" />
          </div>
          <div>
            <label for="purpose">Purpose</label>
            <input id="purpose" name="purpose" type="text" placeholder="Study rationale / objective" />
          </div>
          <div>
            <label for="disease_mondo">Disease (MONDO)</label>
            <input id="disease_mondo" name="disease_mondo" type="text" placeholder="MONDO:XXXXXXX or NA" />
          </div>
          <div>
            <label for="tumor_model">Tumor model</label>
            <select id="tumor_model" name="tumor_model">
              <option value="">— select —</option>
              <option value="patient-derived">patient-derived</option>
              <option value="cell-line">cell-line</option>
              <option value="organoid-biobank">organoid-biobank</option>
            </select>
          </div>
          <div>
            <label for="model_id">Model ID</label>
            <input id="model_id" name="model_id" type="text" placeholder="e.g., PDX-1234 or cell line name" />
          </div>
          <div>
            <label for="passage">Passage</label>
            <input id="passage" name="passage" type="number" min="0" />
          </div>
          <div class="md:col-span-2">
            <label for="genetics">Genetics</label>
            <input id="genetics" name="genetics" type="text" placeholder="e.g., TP53 R175H; EGFR amp" />
          </div>
        </div>
      </section>

      <!-- CELL FRACTIONS -->
      <section class="card">
        <h2 class="section-title">Cell fractions (%)</h2>
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
          <div><label for="cf_tumor">Tumor</label><input id="cf_tumor" type="number" min="0" max="100"></div>
          <div><label for="cf_endo">Endothelial</label><input id="cf_endo" type="number" min="0" max="100"></div>
          <div><label for="cf_fibro">Fibroblast</label><input id="cf_fibro" type="number" min="0" max="100"></div>
          <div><label for="cf_cd8">T CD8</label><input id="cf_cd8" type="number" min="0" max="100"></div>
          <div><label for="cf_cd4">T CD4</label><input id="cf_cd4" type="number" min="0" max="100"></div>
          <div><label for="cf_nk">NK</label><input id="cf_nk" type="number" min="0" max="100"></div>
        </div>
      </section>

      <!-- ENVIRONMENT -->
      <section class="card">
        <h2 class="section-title">Environment / Culture</h2>
        <div class="subgrid">
          <div>
            <label for="ecm_composition">ECM composition</label>
            <input id="ecm_composition" type="text" placeholder="Collagen I + Matrigel or NA" />
          </div>
          <div>
            <label for="ecm_conc">ECM concentration (mg/mL)</label>
            <input id="ecm_conc" type="number" step="0.1" />
          </div>
          <div>
            <label for="ecm_stiff">Stiffness (kPa)</label>
            <input id="ecm_stiff" type="number" step="0.1" />
          </div>
          <div>
            <label for="flow_rate">Perfusion rate (µL/min)</label>
            <input id="flow_rate" type="number" step="0.1" />
          </div>
          <div>
            <label for="oxygen_set">O₂ setpoint (%)</label>
            <input id="oxygen_set" type="number" step="0.1" />
          </div>
          <div>
            <label for="incubator">Incubator</label>
            <input id="incubator" type="text" placeholder="37°C / 5% CO₂" />
          </div>
          <div>
            <label for="media">Media</label>
            <input id="media" type="text" placeholder="DMEM/F12 or RPMI-1640" />
          </div>
          <div>
            <label for="serum">Serum</label>
            <input id="serum" type="text" placeholder="serum-free / %FBS" />
          </div>
          <div class="md:col-span-2">
            <label for="supplements">Supplements (one per line)</label>
            <textarea id="supplements" rows="3" placeholder="EGF; #12345; 50 ng/mL"></textarea>
          </div>
        </div>
      </section>

      <!-- STIMULI (DYNAMIC) -->
      <section class="card">
        <h2 class="section-title">Stimuli</h2>
        <div id="stimuli-list" class="space-y-3"></div>
        <button id="btn-add-stimulus" type="button" class="btn btn-secondary mt-2">+ Add stimulus</button>
      </section>

      <!-- READOUTS -->
      <section class="card">
        <h2 class="section-title">Readouts</h2>
        <div class="subgrid">
          <div><label for="rd_pathways">Pathways / markers</label><input id="rd_pathways" type="text" placeholder="NFκB reporter; pSTAT1" /></div>
          <div><label for="rd_rna">RNA</label><input id="rd_rna" type="text" placeholder="scRNA-seq / bulk RNA-seq / EV RNA-seq" /></div>
          <div><label for="rd_prot">Proteomics</label><input id="rd_prot" type="text" placeholder="TMT-MS / DIA" /></div>
          <div><label for="rd_metab">Metabolomics</label><input id="rd_metab" type="text" placeholder="LC-MS" /></div>
          <div><label for="rd_epi">Epigenetics</label><input id="rd_epi" type="text" placeholder="ATAC-seq" /></div>
        </div>
      </section>

      <!-- SCHEDULING / IMAGING -->
      <section class="card">
        <h2 class="section-title">Timing & Imaging</h2>
        <div class="subgrid">
          <div><label for="timepoints">Timepoints (h)</label><input id="timepoints" type="text" placeholder="0,6,24,48" /></div>
          <div><label for="duration">Duration (h)</label><input id="duration" type="number" /></div>
          <div><label for="sampling">Sampling (h)</label><input id="sampling" type="text" placeholder="0,6,24,48,72,96" /></div>
          <div><label for="replicates">Replicates</label><input id="replicates" type="text" placeholder="3 bio × 2 tech" /></div>
          <div><label for="img_modal">Imaging modalities</label><input id="img_modal" type="text" placeholder="confocal; IF; TEM" /></div>
          <div><label for="img_quant">Imaging quantification</label><input id="img_quant" type="text" placeholder="infiltration index; clustering coef." /></div>
        </div>
      </section>

      <!-- CONTROLS & QC -->
      <section class="card">
        <h2 class="section-title">Controls & Quality</h2>
        <div class="subgrid">
          <div class="md:col-span-2"><label for="controls">Controls (one per line)</label><textarea id="controls" rows="3" placeholder="vehicle\nIFNγ treatment"></textarea></div>
          <div><label for="qc_viability">Viability (%)</label><input id="qc_viability" type="number" step="0.1" /></div>
          <div><label for="qc_prolif">Proliferation</label><input id="qc_prolif" type="text" placeholder="Ki‑67 40%" /></div>
          <div><label for="qc_apop">Apoptosis</label><input id="qc_apop" type="text" placeholder="Caspase‑3 8%" /></div>
          <div class="md:col-span-2"><label for="qc_contam">Contamination</label><input id="qc_contam" type="text" placeholder="Mycoplasma negative (YYYY‑MM‑DD)" /></div>
        </div>
      </section>

      <!-- CYTOKINES (DYNAMIC) -->
      <section class="card">
        <h2 class="section-title">Cytokines</h2>
        <div id="cytokines-list" class="space-y-3"></div>
        <button id="btn-add-cyt" type="button" class="btn btn-secondary mt-2">+ Add cytokine</button>
      </section>

      <!-- FILES & META -->
      <section class="card">
        <h2 class="section-title">Files & Metadata</h2>
        <div class="subgrid">
          <div class="md:col-span-2"><label for="files">Files (one path per line)</label><textarea id="files" rows="3" placeholder="/data/omics/run1.fastq.gz\n/data/imaging/exp42.ome.zarr"></textarea></div>
          <div><label for="metadata_std">Metadata standards</label><input id="metadata_std" type="text" placeholder="MIACME; OME‑NGFF" /></div>
          <div><label for="lr_pairs">Ligand–Receptor pairs</label><input id="lr_pairs" type="text" placeholder="PD‑1/PD‑L1" /></div>
          <div><label for="secreted_ecm">Secreted ECM</label><input id="secreted_ecm" type="text" placeholder="Fibronectin" /></div>
        </div>
        <div class="mt-4"><label for="notes">Notes</label><textarea id="notes" rows="4"></textarea></div>
      </section>
    </form>

    <footer class="text-sm text-gray-500 pb-8">© 2025 CyberChip · Built for ontology/ABM workflows</footer>
  </div>

  <!-- Templates for dynamic rows -->
  <template id="tmpl-stimulus">
    <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end bg-gray-50 p-3 rounded-xl">
      <div><label>Agent</label><input type="text" class="s-agent" placeholder="IL‑33" /></div>
      <div><label>Conc</label><input type="number" step="0.0001" class="s-conc" placeholder="10" /></div>
      <div><label>Unit</label><input type="text" class="s-unit" placeholder="ng/mL" /></div>
      <div><label>Start (h)</label><input type="number" class="s-start" placeholder="0" /></div>
      <div><label>Interval (h)</label><input type="number" class="s-interval" placeholder="0" /></div>
      <div><label>Duration (h)</label><input type="number" class="s-duration" placeholder="24" /></div>
      <div class="md:col-span-6 flex justify-end gap-2">
        <button type="button" class="btn btn-secondary btn-duplicate">Duplicate</button>
        <button type="button" class="btn btn-danger btn-remove">Remove</button>
      </div>
    </div>
  </template>

  <template id="tmpl-cytokine">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end bg-gray-50 p-3 rounded-xl">
      <div><label>Name</label><input type="text" class="c-name" placeholder="VEGF‑A" /></div>
      <div><label>Unit</label><input type="text" class="c-unit" placeholder="pg/mL" /></div>
      <div><label>Notes</label><input type="text" class="c-notes" placeholder="ELISA" /></div>
      <div class="flex justify-end gap-2">
        <button type="button" class="btn btn-secondary btn-duplicate">Duplicate</button>
        <button type="button" class="btn btn-danger btn-remove">Remove</button>
      </div>
    </div>
  </template>

  <script>
    // ---------- helpers ----------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function addRow(listEl, tmplId) {
      const t = document.getElementById(tmplId);
      const node = t.content.firstElementChild.cloneNode(true);
      listEl.appendChild(node);
      // wire buttons
      $('.btn-remove', node).addEventListener('click', () => node.remove());
      $('.btn-duplicate', node).addEventListener('click', () => {
        const clone = node.cloneNode(true);
        // rewire within clone
        $('.btn-remove', clone).addEventListener('click', () => clone.remove());
        $('.btn-duplicate', clone).addEventListener('click', () => {
          const c2 = clone.cloneNode(true);
          $('.btn-remove', c2).addEventListener('click', () => c2.remove());
          $('.btn-duplicate', c2).addEventListener('click', () => {/* noop nesting */});
          clone.parentElement.insertBefore(c2, clone.nextSibling);
        });
        node.parentElement.insertBefore(clone, node.nextSibling);
      });
      return node;
    }

    // ---------- dynamic lists ----------
    const stimuliList = document.getElementById('stimuli-list');
    const cytokinesList = document.getElementById('cytokines-list');

    document.getElementById('btn-add-stimulus').addEventListener('click', () => addRow(stimuliList, 'tmpl-stimulus'));
    document.getElementById('btn-add-cyt').addEventListener('click', () => addRow(cytokinesList, 'tmpl-cytokine'));

    // ---------- serialization ----------
    function collectForm() {
      const data = {
        project_id: $('#project_id').value || '',
        species: $('#species').value || '',
        tissue: $('#tissue').value || '',
        purpose: $('#purpose').value || '',
        disease_mondo: $('#disease_mondo').value || '',
        tumor_model: $('#tumor_model').value || '',
        model_id: $('#model_id').value || '',
        passage: $('#passage').value ? Number($('#passage').value) : null,
        genetics: $('#genetics').value || '',
        cell_fractions: {
          tumor: Number($('#cf_tumor').value||0),
          endothelial: Number($('#cf_endo').value||0),
          fibroblast: Number($('#cf_fibro').value||0),
          t_cd8: Number($('#cf_cd8').value||0),
          t_cd4: Number($('#cf_cd4').value||0),
          nk: Number($('#cf_nk').value||0),
        },
        ecm: {
          composition: $('#ecm_composition').value || '',
          concentration_mg_ml: $('#ecm_conc').value ? Number($('#ecm_conc').value) : null,
          stiffness_kpa: $('#ecm_stiff').value ? Number($('#ecm_stiff').value) : null,
        },
        flow: {
          perfused: Boolean(Number($('#flow_rate').value||0)),
          rate_ul_min: $('#flow_rate').value ? Number($('#flow_rate').value) : 0,
        },
        oxygen: {
          controlled: $('#oxygen_set').value !== '',
          setpoint_percent: $('#oxygen_set').value ? Number($('#oxygen_set').value) : null,
        },
        incubator: $('#incubator').value || '',
        media: $('#media').value || '',
        serum: $('#serum').value || '',
        supplements: $('#supplements').value.trim(),
        stimuli: $$('#stimuli-list > div').map(row => ({
          agent: $('.s-agent', row).value,
          conc: $('.s-conc', row).value ? Number($('.s-conc', row).value) : null,
          unit: $('.s-unit', row).value,
          start_h: $('.s-start', row).value ? Number($('.s-start', row).value) : 0,
          interval_h: $('.s-interval', row).value ? Number($('.s-interval', row).value) : 0,
          duration_h: $('.s-duration', row).value ? Number($('.s-duration', row).value) : 0,
        })),
        readouts: {
          pathways: $('#rd_pathways').value || '',
          rna: $('#rd_rna').value || '',
          proteomics: $('#rd_prot').value || '',
          metabolomics: $('#rd_metab').value || '',
          epigenetics: $('#rd_epi').value || '',
        },
        timepoints_h: $('#timepoints').value ? $('#timepoints').value.split(',').map(s=>Number(s.trim())).filter(n=>!Number.isNaN(n)) : [],
        lr_pairs: $('#lr_pairs').value || '',
        secreted_ecm: $('#secreted_ecm').value || '',
        imaging_modalities: $('#img_modal').value || '',
        imaging_quant: $('#img_quant').value || '',
        duration_h: $('#duration').value ? Number($('#duration').value) : null,
        sampling: $('#sampling').value || '',
        replicates: $('#replicates').value || '',
        controls: $('#controls').value ? $('#controls').value.split(/\n+/).map(s=>s.trim()).filter(Boolean) : [],
        qc: {
          viability: $('#qc_viability').value ? Number($('#qc_viability').value) : null,
          proliferation: $('#qc_prolif').value || '',
          apoptosis: $('#qc_apop').value || '',
          contamination: $('#qc_contam').value || '',
        },
        cytokines: $$('#cytokines-list > div').map(row => ({
          name: $('.c-name', row).value,
          unit: $('.c-unit', row).value,
          notes: $('.c-notes', row).value,
        })),
        files: $('#files').value ? $('#files').value.split(/\n+/).map(s=>s.trim()).filter(Boolean) : [],
        metadata_std: $('#metadata_std').value || '',
        notes: $('#notes').value || '',
      };
      return data;
    }

    function fillForm(data) {
      const set = (id, val) => { const el = document.getElementById(id); if (!el) return; if (el.tagName==='SELECT') { el.value = val || ''; } else { el.value = val ?? ''; } };
      set('project_id', data.project_id);
      set('species', data.species);
      set('tissue', data.tissue);
      set('purpose', data.purpose);
      set('disease_mondo', data.disease_mondo);
      set('tumor_model', data.tumor_model);
      set('model_id', data.model_id);
      set('passage', data.passage);
      set('genetics', data.genetics);
      if (data.cell_fractions) {
        set('cf_tumor', data.cell_fractions.tumor);
        set('cf_endo', data.cell_fractions.endothelial);
        set('cf_fibro', data.cell_fractions.fibroblast);
        set('cf_cd8', data.cell_fractions.t_cd8);
        set('cf_cd4', data.cell_fractions.t_cd4);
        set('cf_nk', data.cell_fractions.nk);
      }
      if (data.ecm) {
        set('ecm_composition', data.ecm.composition);
        set('ecm_conc', data.ecm.concentration_mg_ml);
        set('ecm_stiff', data.ecm.stiffness_kpa);
      }
      if (data.flow) {
        set('flow_rate', data.flow.rate_ul_min);
      }
      if (data.oxygen) {
        set('oxygen_set', data.oxygen.setpoint_percent);
      }
      set('incubator', data.incubator);
      set('media', data.media);
      set('serum', data.serum);
      set('supplements', data.supplements);

      // Stimuli
      stimuliList.innerHTML = '';
      (data.stimuli||[]).forEach(st => {
        const row = addRow(stimuliList, 'tmpl-stimulus');
        $('.s-agent', row).value = st.agent ?? '';
        $('.s-conc', row).value = st.conc ?? '';
        $('.s-unit', row).value = st.unit ?? '';
        $('.s-start', row).value = st.start_h ?? 0;
        $('.s-interval', row).value = st.interval_h ?? 0;
        $('.s-duration', row).value = st.duration_h ?? 0;
      });

      // Readouts
      if (data.readouts) {
        set('rd_pathways', data.readouts.pathways);
        set('rd_rna', data.readouts.rna);
        set('rd_prot', data.readouts.proteomics);
        set('rd_metab', data.readouts.metabolomics);
        set('rd_epi', data.readouts.epigenetics);
      }

      set('timepoints', (data.timepoints_h||[]).join(','));
      set('lr_pairs', data.lr_pairs);
      set('secreted_ecm', data.secreted_ecm);
      set('img_modal', data.imaging_modalities);
      set('img_quant', data.imaging_quant);
      set('duration', data.duration_h);
      set('sampling', data.sampling);
      set('replicates', data.replicates);

      set('controls', (data.controls||[]).join('\n'));

      if (data.qc) {
        set('qc_viability', data.qc.viability);
        set('qc_prolif', data.qc.proliferation);
        set('qc_apop', data.qc.apoptosis);
        set('qc_contam', data.qc.contamination);
      }

      cytokinesList.innerHTML = '';
      (data.cytokines||[]).forEach(cy => {
        const row = addRow(cytokinesList, 'tmpl-cytokine');
        $('.c-name', row).value = cy.name ?? '';
        $('.c-unit', row).value = cy.unit ?? '';
        $('.c-notes', row).value = cy.notes ?? '';
      });

      set('files', (data.files||[]).join('\n'));
      set('metadata_std', data.metadata_std);
      set('notes', data.notes);
    }

    function resetForm() {
      document.getElementById('exp-form').reset();
      stimuliList.innerHTML = '';
      cytokinesList.innerHTML = '';
    }

    // ---------- demo payload (IL‑33 / eosinophil EV) ----------
    function prefillDemo(){
      fillForm({
        project_id: "OCC-2025-IL33-EoEV",
        species: "Mus musculus (10090); Homo sapiens (9606)",
        tissue: "UBERON:0000178",
        purpose: "Test effects of extracellular vesicles (EVs) from IL‑33–activated eosinophils on tumor cells (cell‑cycle, phenotype, migration, metastasis).",
        disease_mondo: "NA",
        tumor_model: "cell-line",
        model_id: "unspecified (per abstract)",
        passage: null,
        genetics: "",
        cell_fractions: { tumor: 100, endothelial: 0, fibroblast: 0, t_cd8: 0, t_cd4: 0, nk: 0 },
        ecm: { composition: "NA (primarily 2D); spheroids for some assays", concentration_mg_ml: 0, stiffness_kpa: null },
        flow: { perfused: false, rate_ul_min: 0 },
        oxygen: { controlled: false, setpoint_percent: null },
        incubator: "37°C / 5% CO₂",
        media: "RPMI‑1640 (eosinophils) / DMEM (recipient tumor cells)",
        serum: "serum‑free during EV collection; standard otherwise",
        supplements: "",
        stimuli: [
          { agent: "IL‑33 (donor activation)", conc: 10, unit: "ng/mL", start_h: 0, interval_h: 0, duration_h: 24 },
          { agent: "IL‑5 (control donor activation)", conc: 10, unit: "ng/mL", start_h: 0, interval_h: 0, duration_h: 24 },
          { agent: "Eo33‑EV (to tumor cells)", conc: 1e9, unit: "particles/mL", start_h: 0, interval_h: 0, duration_h: 48 },
          { agent: "Eo5‑EV (control to tumor cells)", conc: 1e9, unit: "particles/mL", start_h: 0, interval_h: 0, duration_h: 48 }
        ],
        readouts: {
          pathways: "Epithelial shift markers (E‑cadherin↑, N‑cadherin↓); cell‑cycle regulators (CDK inhibitors↑)",
          rna: "EV RNA‑seq (tumor‑suppressor/epithelial/negative‑regulation pathways enriched in Eo33‑EV)",
          proteomics: "NA",
          metabolomics: "NA",
          epigenetics: "NA"
        },
        timepoints_h: [0,24,48,72],
        lr_pairs: "",
        secreted_ecm: "NA",
        imaging_modalities: "confocal; TEM; brightfield",
        imaging_quant: "cell elongation index; migration distance; spheroid area",
        duration_h: 72,
        sampling: "0,24,48,72",
        replicates: "≥3 bio × 2 tech",
        controls: ["Eo5‑EV (IL‑5–activated eosinophil EVs)", "no‑EV vehicle"],
        qc: { viability: null, proliferation: "Ki‑67 ↓ with Eo33‑EV", apoptosis: "context‑dependent", contamination: "Mycoplasma negative (if tested)" },
        cytokines: [],
        files: [
          "/data/ev/np_tracking/Eo33EV_counts.csv",
          "/data/transcriptomics/EV_RNAseq/manifest.txt",
          "/data/imaging/morphology/fields.ome.zarr"
        ],
        metadata_std: "MISEV2018; OME‑NGFF; MIACME (partial)",
        notes: "Eo33‑EV uptake drives CDKI expression and G0/G1 arrest; epithelial‑like features; reduced migration and spheroid formation; in vivo syngeneic model: lung metastasis ↓. Normalize EV dose by protein/particle count; include Eo5‑EV as control for difference graphs."
      });
    }

    // expose for inline handlers or console
    window.fillForm = fillForm;
    window.prefillDemo = prefillDemo;

    // ---------- wiring ----------
    document.getElementById('btn-demo-fill').addEventListener('click', (e) => { e.preventDefault(); prefillDemo(); alert('Demo filled.'); });
    document.getElementById('btn-reset').addEventListener('click', (e) => { e.preventDefault(); resetForm(); });

    document.getElementById('btn-export').addEventListener('click', (e) => {
      e.preventDefault();
      const data = collectForm();
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (data.project_id || 'experiment') + '.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    document.getElementById('file-import').addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const text = await file.text();
      try {
        const data = JSON.parse(text);
        fillForm(data);
        alert('Imported JSON and filled form.');
      } catch (err) {
        alert('Invalid JSON: ' + err.message);
      }
      e.target.value = '';
    });

    // Optional: auto-run demo via ?demo=1
    const q = new URLSearchParams(location.search);
    if (q.has('demo')) prefillDemo();
  </script>
</body>
</html>
